---
title: "feat: GitHub Actions CI/CD workflow with pnpm and changesets"
type: feat
status: completed
date: 2026-02-28
origin: docs/brainstorms/2026-02-28-github-workflow-brainstorm.md
---

# GitHub Actions CI/CD Workflow

## Overview

Set up two GitHub Actions workflows, migrate from npm to pnpm, and add changesets for changelog generation. The release workflow publishes to GitHub Packages, triggered by git tags.

(See brainstorm: `docs/brainstorms/2026-02-28-github-workflow-brainstorm.md` for approach rationale.)

## Acceptance Criteria

- [x] `pnpm install`, `pnpm build`, `pnpm test` work locally
- [x] `package-lock.json` removed, `pnpm-lock.yaml` present
- [x] `.changeset/config.json` exists with correct settings
- [ ] `pnpm changeset` creates changeset files (verified post-merge)
- [ ] `pnpm changeset version` bumps package.json + generates CHANGELOG.md (verified post-merge)
- [x] CI workflow runs on push/PR: build + test
- [x] Release workflow runs on `v*` tag: build + publish to GitHub Packages
- [x] `package.json` has `publishConfig` pointing to GitHub Packages
- [x] README updated with GitHub Packages install instructions

## Task Breakdown

### Task 1: Migrate npm to pnpm

**Files to modify:**
- Delete `package-lock.json`
- Update `package.json` — change `prepublishOnly` script from `npm run build` to `pnpm run build`
- Add `packageManager` field to `package.json` (enables corepack)
- Generate `pnpm-lock.yaml`

**Steps:**
```bash
rm package-lock.json
# Update package.json prepublishOnly: "pnpm run build"
# Add "packageManager": "pnpm@10.x.x" to package.json
pnpm install  # generates pnpm-lock.yaml
pnpm build    # verify build works
pnpm test     # verify tests pass
```

**Verify after:**
- `pnpm build` compiles cleanly
- `pnpm test` passes (30/30)
- No `package-lock.json` exists
- `pnpm-lock.yaml` is committed

---

### Task 2: Initialize changesets

**Files to create:**
- `.changeset/config.json`
- `.changeset/README.md` (auto-generated by `changeset init`)

**Steps:**
```bash
pnpm add -D @changesets/cli
pnpm changeset init
```

**Edit `.changeset/config.json`:**
```json
{
  "$schema": "https://unpkg.com/@changesets/config@3.1.1/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [],
  "access": "public",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
```

Key settings:
- `"access": "public"` — needed for scoped package publishing
- `"commit": false` — don't auto-commit version bumps (we do it manually)
- `"baseBranch": "main"` — matches our default branch

**Add scripts to `package.json`:**
```json
{
  "scripts": {
    "changeset": "changeset",
    "version": "changeset version",
    "release": "changeset publish"
  }
}
```

**Verify after:**
- `pnpm changeset` prompts for changeset creation
- `.changeset/config.json` has correct settings

---

### Task 3: Configure GitHub Packages in package.json

**Modify `package.json`:**

Add `publishConfig` to direct publishing to GitHub Packages:

```json
{
  "publishConfig": {
    "registry": "https://npm.pkg.github.com",
    "access": "public"
  }
}
```

**Note:** GitHub Packages requires the package scope to match the GitHub owner. `@lucabattistini/concinnitas` matches `github.com/lucabattistini/concinnitas` — this is correct.

---

### Task 4: Create CI workflow (`.github/workflows/ci.yml`)

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - run: pnpm build

      - run: pnpm test
```

Key points:
- `pnpm/action-setup@v4` reads `packageManager` from `package.json` to get the right pnpm version
- `actions/setup-node@v4` with `cache: 'pnpm'` enables dependency caching
- `--frozen-lockfile` ensures CI uses exact locked versions
- Node 22 is current LTS

---

### Task 5: Create Release workflow (`.github/workflows/release.yml`)

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'

      - run: pnpm install --frozen-lockfile

      - run: pnpm build

      - run: pnpm test

      - run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

Key points:
- Triggers on `v*` tags (e.g., `v1.0.0`, `v1.1.0`)
- `permissions.packages: write` allows publishing to GitHub Packages
- `registry-url` in `setup-node` configures `.npmrc` for GitHub Packages auth
- `GITHUB_TOKEN` is automatically available — no manual secret needed
- `--no-git-checks` because we're in a detached HEAD state on a tag
- Tests run again in the release workflow as a safety gate
- Uses `pnpm publish` directly (not `changeset publish`) since version is already set by changesets locally

---

### Task 6: Update README with GitHub Packages install instructions

The install section needs to explain the `.npmrc` setup since GitHub Packages requires it.

Update the Install section:

```markdown
## Install

First, configure npm to use GitHub Packages for the `@lucabattistini` scope:

```sh
echo "@lucabattistini:registry=https://npm.pkg.github.com" >> ~/.npmrc
```

Then install:

```sh
npx @lucabattistini/concinnitas install
```

Restart OpenCode. The `/design:*` commands appear in your skill list.
```

---

### Task 7: Verify everything works end-to-end

- [x] `pnpm install` — clean install
- [x] `pnpm build` — compiles cleanly
- [x] `pnpm test` — all tests pass (30/30)
- [ ] `pnpm changeset` — creates a changeset file (verified post-merge)
- [ ] `pnpm version` — bumps package.json and generates CHANGELOG.md (verified post-merge)
- [ ] Commit and push to trigger CI workflow
- [ ] Verify CI workflow passes on GitHub Actions

**Note:** The actual publish (tag push) should be tested after the PR is merged, since the release workflow uses `GITHUB_TOKEN` which requires the repo context.

---

## Release Flow (for reference)

After this is set up, the release process becomes:

```bash
# 1. During development, create changesets for notable changes
pnpm changeset
# Answer prompts: patch/minor/major + description

# 2. When ready to release, consume changesets
pnpm version
# This bumps package.json version + generates/updates CHANGELOG.md

# 3. Commit the version bump
git add .
git commit -m "chore(release): v1.1.0"

# 4. Tag and push
git tag v1.1.0
git push origin main --follow-tags

# 5. GitHub Actions release workflow publishes to GitHub Packages
```

## What This Does NOT Do

- Does not publish to npm public registry (GitHub Packages only)
- Does not auto-merge or auto-release (tag is manual)
- Does not set up branch protection rules
- Does not add code coverage reporting
- Does not create GitHub Releases (just publishes the package)

## Sources

- **Origin brainstorm:** [docs/brainstorms/2026-02-28-github-workflow-brainstorm.md](docs/brainstorms/2026-02-28-github-workflow-brainstorm.md)
- GitHub Actions pnpm setup: https://github.com/pnpm/action-setup
- GitHub Packages npm docs: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry
- Changesets docs: https://github.com/changesets/changesets
